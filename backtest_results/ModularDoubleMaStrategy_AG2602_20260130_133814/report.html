<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>回测分析报告</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --sidebar-bg: #2b323a;
            --sidebar-hover: #39424d;
            --active-blue: #3281f8;
            --bg-gray: #f2f4f7;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #888;
            --red: #eb4d3d;
            --green: #37b366;
            --border: #e6e9ed;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg-gray); overflow: hidden; }
        
        /* 布局结构 */
        .app-container { display: flex; height: 100vh; }
        
        /* 侧边栏 */
        .sidebar { width: 160px; background: var(--sidebar-bg); color: #b0b6c1; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { height: 50px; line-height: 50px; text-align: center; font-weight: bold; font-size: 16px; color: white; background: #22282e; }
        .nav-item { padding: 15px 20px; cursor: pointer; font-size: 13px; border-left: 3px solid transparent; transition: all 0.2s; }
        .nav-item:hover { background: var(--sidebar-hover); color: white; }
        .nav-item.active { background: #262c34; color: white; border-left-color: var(--active-blue); font-weight: bold; }
        
        /* 主区域 */
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        /* 顶部筛选栏 */
        .top-bar { height: 50px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
        .meta-info { font-size: 13px; color: var(--text-main); display: flex; gap: 20px; }
        .meta-info span b { margin-left: 5px; }
        .filter-controls { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .filter-select { padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .date-picker { padding: 4px; border: 1px solid #ddd; border-radius: 3px; color: #555; }
        
        /* 滚动内容区 */
        .page-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* 通用组件 */
        .card { background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .card-header { font-size: 14px; font-weight: bold; border-left: 3px solid var(--active-blue); padding-left: 10px; margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; }
        
        .chart-box { width: 100%; height: 320px; }
        
        /* 表格 */
        .v3-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .v3-table th { background: #fafafa; text-align: left; padding: 10px; color: #666; font-weight: normal; border-bottom: 1px solid #eee; }
        .v3-table td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
        .text-red { color: var(--red); }
        .text-green { color: var(--green); }
        
        /* P1 绩效概览特定样式 */
        .overview-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 15px; }
        .stats-sidebar { display: flex; flex-direction: column; gap: 10px; }
        .key-stat-item { display: flex; justify-content: space-between; font-size: 13px; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .key-stat-label { color: #888; }
        .key-stat-val { font-weight: bold; color: #333; }
        
        /* P3 统计网格 */
        .stats-matrix { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .matrix-item { background: #fcfcfc; border: 1px solid #f0f0f0; padding: 15px; text-align: center; border-radius: 4px; }
        .matrix-label { font-size: 12px; color: #999; margin-bottom: 5px; }
        .matrix-val { font-size: 18px; font-weight: bold; color: #444; }

        /* P5 K线图容器 */
        #chart-kline { height: 500px; }
        
        /* 日志区域 */
        #log-viewer { font-family: "Consolas", monospace; font-size: 12px; color: #555; white-space: pre-wrap; line-height: 1.5; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="logo-area">策略回测报告</div>
        <div class="nav-item active" onclick="navTo('p1')">绩效概览</div>
        <div class="nav-item" onclick="navTo('p2')">持仓分析</div>
        <div class="nav-item" onclick="navTo('p3')">Tharp统计</div>
        <div class="nav-item" onclick="navTo('p4')">每日明细</div>
        <div class="nav-item" onclick="navTo('p5')">信号分析</div>
        <div class="nav-item" onclick="navTo('p6')">回测日志</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="meta-info">
                <span>策略: <b id="meta-strategy">--</b></span>
                <span>期初资金: <b id="meta-capital">--</b></span>
                <span>回测时间: <b id="meta-range">--</b></span>
            </div>
            <div class="filter-controls">
                <select id="range-preset" class="filter-select" onchange="applyPreset(this.value)">
                    <option value="all">成立以来</option>
                    <option value="ytd">本年 (YTD)</option>
                    <option value="1y">近一年</option>
                    <option value="mtd">本月</option>
                </select>
                <span>从</span>
                <input type="date" id="date-start" class="date-picker" onchange="applyCustomDate()">
                <span>至</span>
                <input type="date" id="date-end" class="date-picker" onchange="applyCustomDate()">
            </div>
        </div>

        <div class="page-scroll">
            
            <div id="p1" class="page active">
                <div class="overview-grid">
                    <div class="left-charts">
                        <div class="card">
                            <div class="card-header">统计指标</div>
                            <div id="stats-matrix" class="stats-matrix"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">累计收益</div>
                            <div id="chart-balance" class="chart-box"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">回撤详情</div>
                            <div id="chart-drawdown" class="chart-box" style="height: 250px;"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">每日收益率</div>
                            <div id="chart-daily-pnl" class="chart-box" style="height: 200px;"></div>
                        </div>
                    <div class="card">
                        <div class="card-header">R倍数分布直方图 (0.5R 间隔)</div>
                        <div id="chart-r-dist" class="chart-box" style="height: 350px;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">R倍数序列图</div>
                        <div id="chart-r-sequence" class="chart-box" style="height: 300px;"></div>
                    </div>
                    </div>
                    <div class="stats-sidebar">
                        <div class="card">
                            <div class="card-header">核心指标</div>
                            <div id="key-stats-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="p2" class="page">
                <div class="card">
                    <div class="card-header">资产分布 (现金 vs 持仓)</div>
                    <div id="chart-asset-dist" class="chart-box"></div>
                </div>
                <div class="card">
                    <div class="card-header">每日快照</div>
                    <table class="v3-table">
                        <thead><tr><th>日期</th><th>总资产</th><th>持仓盈亏</th><th>最大回撤</th><th>手续费/滑点</th></tr></thead>
                        <tbody id="table-daily-snap"></tbody>
                    </table>
                </div>
            </div>

            <div id="p3" class="page">
            </div>

            <div id="p4" class="page">
                <div class="card">
                    <div class="card-header">每日交易流水</div>
                    <div style="padding: 40px; text-align: center; color: #999;">
                        此处可扩展显示每日具体的订单成交明细流水。
                        <br>当前数据包已包含 Trades 数据，可在此渲染。
                    </div>
                </div>
            </div>

            <div id="p5" class="page">
                <div class="card">
                    <div class="card-header">
                        <span>K线与买卖点 (1分钟)</span>
                        <span style="font-weight: normal; font-size: 12px; color: #888;">提示: 滚轮缩放，拖拽平移</span>
                    </div>
                    <div id="chart-kline"></div>
                </div>
                <div class="card">
                    <div class="card-header">成交记录表</div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="v3-table">
                            <thead><tr><th>时间</th><th>代码</th><th>方向</th><th>开平</th><th>价格</th><th>数量</th></tr></thead>
                            <tbody id="table-trades"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="p6" class="page">
                <div class="card">
                    <div class="card-header">运行日志</div>
                    <div id="log-viewer"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="data.js"></script>

<script>
    // --- 全局变量 ---
    const rawData = window.BACKTEST_DATA;
    let filteredDaily = [];
    let charts = {}; // 存储 echarts 实例

    // --- 初始化 ---
window.onload = function() {
    if (!rawData) {
        alert("未找到数据文件 data.js，请确认回测已运行。");
        return;
    }
    
    // 1. 填充头部元数据
    document.getElementById('meta-strategy').innerText = rawData.metadata.strategy;
    document.getElementById('meta-capital').innerText = rawData.metadata.capital.toLocaleString();
    document.getElementById('meta-range').innerText = `${rawData.metadata.start} ~ ${rawData.metadata.end}`;
    
    // 2. 初始化日期选择器范围
    const allDaily = rawData.daily_data;
    if(allDaily.length > 0) {
        document.getElementById('date-start').value = allDaily[0].date;
        document.getElementById('date-end').value = allDaily[allDaily.length-1].date;
    }

    // 3. 渲染非时间相关内容 (日志, 统计概览)
    renderStaticContent();
    
    // 4. 触发首次计算和渲染 (时间相关)
    applyCustomDate(); 
    
    // 5. 初始化当前激活页面的图表
    const activePage = document.querySelector('.page.active');
    if (activePage) {
        const pageId = activePage.id;
        if (pageId === 'p1') renderRCharts();
        if (pageId === 'p5') renderKlineChart();
        if (pageId === 'p4') renderTradesTable();
    }
};

    // --- 导航逻辑 ---
    function navTo(pageId) {
        // 切换 Active 类
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        
        // 激活目标
        event.currentTarget.classList.add('active');
        document.getElementById(pageId).classList.add('active');

        if (pageId === 'p4') renderTradesTable();

        // 核心：ECharts 在 display:none 容器中无法正确获取尺寸
        // 切换后必须 resize，且如果是首次显示的图表需要初始化
        setTimeout(() => {
            Object.values(charts).forEach(c => c.resize());
            if (pageId === 'p5') renderKlineChart(); // 信号图数据量大，按需加载
                if (pageId === 'p1') renderRCharts(); // R 统计图表
        }, 50);
    }

    // --- 数据筛选逻辑 ---
    function applyPreset(type) {
        const end = new Date(); // 今天
        let start = new Date();
        const dataStart = new Date(rawData.daily_data[0].date);

        switch(type) {
            case 'all': start = dataStart; break;
            case 'ytd': start = new Date(end.getFullYear(), 0, 1); break;
            case 'mtd': start = new Date(end.getFullYear(), end.getMonth(), 1); break;
            case '1y': start.setFullYear(end.getFullYear() - 1); break;
        }

        // 边界检查
        if (start < dataStart) start = dataStart;
        
        document.getElementById('date-start').value = formatDate(start);
        document.getElementById('date-end').value = formatDate(end);
        applyCustomDate();
    }

    function applyCustomDate() {
        const s = document.getElementById('date-start').value;
        const e = document.getElementById('date-end').value;
        
        // 过滤每日数据
        filteredDaily = rawData.daily_data.filter(d => d.date >= s && d.date <= e);
        
        // 重新渲染所有基于 Daily 数据的图表
        renderOverviewCharts();
        renderPositionCharts();
        renderDailyTable();
    }

    function formatDate(d) {
        return d.toISOString().split('T')[0];
    }

    // --- 渲染逻辑区 ---

    function renderStaticContent() {
        // P3: 统计矩阵
        const stats = rawData.stats;
        const matrixContainer = document.getElementById('stats-matrix');
        // 定义展示顺序和格式
        const metrics = [
            ['total_return', '总收益率', '%'],
            ['annual_return', '年化收益', '%'],
            ['max_drawdown', '最大回撤', ''],
            ['sharpe_ratio', '夏普比率', ''],
            ['winning_rate', '胜率', '%'],
            ['profit_loss_ratio', '盈亏比', ''],
            ['total_trade_count', '总交易次数', ''],
            ['total_days', '回测天数', ''],
            ['daily_return', '日均收益', '%'],
            ['return_std', '收益标准差', '%']
        ];
        
        let html = '';
        metrics.forEach(([key, label, suffix]) => {
            let val = stats[key];
            if (val === undefined) return;
            if (typeof val === 'number') val = val.toFixed(2); // 大部分保留2位小数
            html += `
                <div class="matrix-item">
                    <div class="matrix-label">${label}</div>
                    <div class="matrix-val">${val} ${suffix}</div>
                </div>
            `;
        });
        matrixContainer.innerHTML = html;

// P1: 侧边核心指标 (替换为R倍数相关指标)
const tharpStats = rawData.tharp_stats || {};
const rMetrics = [
    ['win_rate', 'R胜率', '%'],
    ['mean_r', 'R均值', ''],
    ['std_r', 'R标准差', ''],
    ['sqn', 'SQN评分', ''],
    ['total_r', '累计总R', '']
];
const keyStatsHtml = rMetrics.map(([key, label, suffix]) => `
    <div class="key-stat-item">
        <span class="key-stat-label">${label}</span>
        <span class="key-stat-val">${Number(tharpStats[key] || 0).toFixed(2)} ${suffix}</span>
    </div>
`).join('');
document.getElementById('key-stats-list').innerHTML = keyStatsHtml;
        // P6: 日志
        if (rawData.logs) {
            document.getElementById('log-viewer').innerText = rawData.logs.join('\n');
        }

        // P5: 交易记录表
        const tradesHtml = rawData.trades.map(t => `
            <tr>
                <td>${t.datetime}</td>
                <td>${t.symbol}</td>
                <td class="${t.direction==='多'?'text-red':'text-green'}">${t.direction}</td>
                <td>${t.offset}</td>
                <td>${t.price}</td>
                <td>${t.volume}</td>
            </tr>
        `).join('');
        document.getElementById('table-trades').innerHTML = tradesHtml;
    }

    function initEchart(domId) {
        if (charts[domId]) charts[domId].dispose();
        charts[domId] = echarts.init(document.getElementById(domId));
        return charts[domId];
    }

    function renderOverviewCharts() {
        const dates = filteredDaily.map(d => d.date);
        
        // 1. 净值曲线 (Balance)
        const chartBal = initEchart('chart-balance');
        chartBal.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: 50, right: 20, top: 20, bottom: 25 },
            xAxis: { type: 'category', data: dates },
            yAxis: { scale: true, splitLine: { show: true, lineStyle: { type: 'dashed' } } },
            series: [{
                name: '账户净值', type: 'line', smooth: true, symbol: 'none',
                data: filteredDaily.map(d => d.balance),
                lineStyle: { width: 2, color: '#3281f8' },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(50, 129, 248, 0.4)' },
                        { offset: 1, color: 'rgba(50, 129, 248, 0.05)' }
                    ])
                }
            }]
        });

        // 2. 回撤图
        const chartDd = initEchart('chart-drawdown');
        chartDd.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: 50, right: 20, top: 20, bottom: 25 },
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value' },
            series: [{
                name: '回撤', type: 'line', symbol: 'none',
                data: filteredDaily.map(d => d.drawdown),
                lineStyle: { width: 1, color: '#eb4d3d' },
                areaStyle: { color: '#eb4d3d', opacity: 0.2 }
            }]
        });

        // 3. 每日盈亏
        const chartPnl = initEchart('chart-daily-pnl');
        chartPnl.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: 50, right: 20, top: 20, bottom: 25 },
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value' },
            series: [{
                name: '当日盈亏', type: 'bar',
                data: filteredDaily.map(d => d.net_pnl),
                itemStyle: {
                    color: function(params) {
                        return params.value >= 0 ? '#eb4d3d' : '#37b366';
                    }
                }
            }]
        });
    }

    function renderPositionCharts() {
        const chartPos = initEchart('chart-asset-dist');
        const dates = filteredDaily.map(d => d.date);
        
        // 简单计算：因为VNPY简易模式没有 distinct available, 假设持仓时占用了一定资金
        // 这里为了展示效果，我们用简单的逻辑：
        // 假设 持仓市值 = abs(balance - available)，但在 simple mode available=balance。
        // 所以我们用一种近似展示：总资产 = 动态权益。
        // 掘金V3这里通常显示：股票市值、现金、冻结资金。
        // 由于没有底层数据，我们直接显示总资产柱状图即可。
        
        chartPos.setOption({
            tooltip: { trigger: 'axis' },
            legend: { top: 0 },
            grid: { left: 60, right: 20, bottom: 30 },
            xAxis: { type: 'category', data: dates },
            yAxis: { scale: true },
            series: [{
                name: '动态权益', type: 'bar',
                data: filteredDaily.map(d => d.balance),
                itemStyle: { color: '#f39c12' }
            }]
        });
    }

    function renderTradesTable() {
        const tbody = document.getElementById('table-trades');
        const trades = rawData.trades;
        
        const html = trades.map(t => `
            <tr>
                <td>${t.datetime}</td>
                <td>${rawData.metadata.symbol}</td>
                <td class="${t.direction==='多'?'text-red':'text-green'}">${t.direction}</td>
                <td>${t.offset}</td>
                <td>${t.price}</td>
                <td>${t.volume}</td>
            </tr>
        `).join('');
        tbody.innerHTML = html;
    }

    function renderDailyTable() {
        const tbody = document.getElementById('table-daily-snap');
        // 只显示最后100条防止卡顿，反序
        const displayData = filteredDaily.slice().reverse();
        
        const html = displayData.map(d => `
            <tr>
                <td>${d.date}</td>
                <td>${d.balance.toFixed(2)}</td>
                <td class="${d.net_pnl >= 0 ? 'text-red' : 'text-green'}">${d.net_pnl.toFixed(2)}</td>
                <td>${d.drawdown.toFixed(2)}</td>
                <td>--</td> <!-- 手续费/滑点数据不可用 -->
            </tr>
        `).join('');
        tbody.innerHTML = html;
    }

    // --- P5 信号图 (最复杂) ---
    function renderKlineChart() {
        if (charts['chart-kline']) return; // 避免重复渲染
        
        const rawKlines = rawData.klines; // [time, o, c, l, h, vol]
        if (!rawKlines || rawKlines.length === 0) return;

        const chart = initEchart('chart-kline');
        
        // 分离数据以符合 ECharts 格式
        const times = rawKlines.map(k => k[0]);
        const values = rawKlines.map(k => [k[1], k[2], k[3], k[4]]); // O, C, L, H
        const volumes = rawKlines.map((k, i) => [i, k[5], k[1] > k[2] ? -1 : 1]); // Index, Vol, ColorSign

        // 构造买卖点 MarkPoint
        const marks = rawData.trades.map(t => {
            const isBuy = t.direction === '多'; // 假设 direction 值为 "多" 或 "空"
            const color = isBuy ? '#eb4d3d' : '#37b366';
            // Offset: 开仓画箭头，平仓画圆点
            const isOpen = t.offset === '开'; 
            
            return {
                name: t.offset,
                coord: [t.datetime, t.price],
                value: t.offset,
                itemStyle: { color: color },
                symbol: isOpen ? (isBuy ? 'arrow' : 'arrow') : 'pin',
                symbolRotate: isOpen ? (isBuy ? 0 : 180) : 0,
                symbolSize: isOpen ? 15 : 10,
                symbolOffset: isOpen ? (isBuy ? [0, 15] : [0, -15]) : [0, 0],
                label: { show: false } // 不遮挡K线
            };
        });

        const option = {
            animation: false, // 关闭动画提升性能
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' }
            },
            axisPointer: { link: { xAxisIndex: 'all' } },
            grid: [
                { left: '5%', right: '5%', height: '60%' },
                { left: '5%', right: '5%', top: '75%', height: '15%' }
            ],
            xAxis: [
                { type: 'category', data: times, scale: true, boundaryGap: false, splitLine: { show: false } },
                { type: 'category', gridIndex: 1, data: times, scale: true, boundaryGap: false, axisLabel: { show: false } }
            ],
            yAxis: [
                { scale: true, splitArea: { show: true } },
                { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisTick: { show: false }, splitLine: { show: false } }
            ],
            dataZoom: [
                { type: 'inside', xAxisIndex: [0, 1], start: 90, end: 100 }, // 默认显示最后10%
                { type: 'slider', xAxisIndex: [0, 1], top: '92%', start: 90, end: 100 }
            ],
            series: [
                {
                    name: 'Price',
                    type: 'candlestick',
                    data: values,
                    itemStyle: {
                        color: '#eb4d3d',
                        color0: '#37b366',
                        borderColor: '#eb4d3d',
                        borderColor0: '#37b366'
                    },
                    markPoint: {
                        data: marks,
                        label: {
                            formatter: function (param) { return param.name; }
                        }
                    }
                },
                {
                    name: 'Volume',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function (params) {
                            return params.value[2] > 0 ? '#eb4d3d' : '#37b366';
                        }
                    }
                }
            ]
        };
        
        chart.setOption(option);
    }


    function renderCoreStats() {
        const s = data.stats;
        const html = [
            ['total_return', '总收益率', '%'], ['annual_return', '年化收益', '%'],
            ['max_drawdown', '最大回撤', '%'], ['sharpe_ratio', '夏普比率', ''],
            ['total_trade_count', '总交易数', '']
        ].map(k => `
            <div class="matrix-item">
                <div class="matrix-label">${k[1]}</div>
                <div class="matrix-val">${Number(s[k[0]]||0).toFixed(2)}${k[2]}</div>
            </div>
        `).join('');
        document.getElementById('core-stats').innerHTML = html;
    }

function renderRCharts() {
    // R倍数分布直方图
    const chartRDist = initEchart('chart-r-dist');
    const rData = rawData.r_data;
    const rValues = rData.map(d => d.r_value);
    
    // 计算直方图数据
    const binSize = 0.5;
    const minR = Math.floor(Math.min(...rValues) / binSize) * binSize;
    const maxR = Math.ceil(Math.max(...rValues) / binSize) * binSize;
    const bins = [];
    for (let i = minR; i <= maxR; i += binSize) {
        bins.push(i);
    }
    
    const histogramData = new Array(bins.length - 1).fill(0);
    rValues.forEach(r => {
        const binIndex = Math.floor((r - minR) / binSize);
        if (binIndex >= 0 && binIndex < histogramData.length) {
            histogramData[binIndex]++;
        }
    });
    
    const binLabels = bins.slice(0, -1).map((bin, i) => `${bin.toFixed(1)}~${bins[i+1].toFixed(1)}`);
    
    chartRDist.setOption({
        tooltip: { trigger: 'axis' },
        grid: { left: 50, right: 20, top: 20, bottom: 50 },
        xAxis: { 
            type: 'category', 
            data: binLabels,
            axisLabel: { rotate: 45 }
        },
        yAxis: { type: 'value' },
        series: [{
            name: 'R倍数分布', type: 'bar',
            data: histogramData,
            itemStyle: { color: '#3281f8' }
        }]
    });
    
    // R倍数序列图
    const chartRSeq = initEchart('chart-r-sequence');
    chartRSeq.setOption({
        tooltip: { trigger: 'axis' },
        grid: { left: 50, right: 20, top: 20, bottom: 25 },
        xAxis: { 
            type: 'category', 
            data: rData.map(d => d.datetime),
            axisLabel: { show: false }
        },
        yAxis: { type: 'value' },
        series: [{
            name: 'R倍数', type: 'bar',
            data: rData.map(d => d.r_value),
            itemStyle: {
                color: function(params) {
                    return params.value >= 0 ? '#37b366' : '#eb4d3d';
                }
            }
        }]
    });
}
    // 在 window.onload 中增加对 Tharp 数据的渲染调用
    // 渲染 Tharp 矩阵
    function renderTharpContent() {
        const ts = rawData.tharp_stats;
        if(!ts) return;
        const matrix = [
            ['win_rate', 'R胜率', '%'],
            ['mean_r', 'R均值', ''],
            ['std_r', 'R标准差', ''],
            ['sqn', 'SQN评分', ''],
            ['total_r', '累计总R', '']
        ];
        document.getElementById('stats-matrix').innerHTML = matrix.map(([key, label, suffix]) => `
            <div class="matrix-item">
                <div class="matrix-label">${label}</div>
                <div class="matrix-val">${Number(ts[key]||0).toFixed(2)} ${suffix}</div>
            </div>
        `).join('');

        renderRCharts();
    }
    // 记得在 navTo('p3') 时调用此渲染函数
    

    // 窗口大小改变时重绘
    window.onresize = function() {
        Object.values(charts).forEach(c => c.resize());
    };

</script>
</body>
</html>