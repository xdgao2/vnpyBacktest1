<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>回测分析报告 - V3风格</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --sidebar-bg: #2b303b;
            --sidebar-text: #a0a6b5;
            --active-bg: #1e222a;
            --active-text: #3498db;
            --main-bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --red: #e74c3c;
            --green: #27ae60;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: var(--main-bg); overflow: hidden; }
        
        /* 布局容器 */
        .container { display: flex; height: 100vh; }
        
        /* 侧边栏 */
        .sidebar { width: 180px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 16px; color: white; border-bottom: 1px solid #3d4452; }
        .nav-item { padding: 15px 20px; cursor: pointer; transition: 0.2s; font-size: 14px; border-left: 4px solid transparent; }
        .nav-item:hover { background: #3d4452; color: white; }
        .nav-item.active { background: var(--active-bg); color: var(--active-text); border-left-color: var(--active-text); font-weight: bold; }

        /* 主内容区 */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 顶部工具栏 */
        .topbar { background: white; padding: 10px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; z-index: 10; flex-shrink: 0;}
        .top-info { font-size: 14px; color: #666; display: flex; gap: 20px; }
        .top-info span b { color: #333; margin-left: 5px; }
        
        .filter-group { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .date-btn { border: 1px solid #ddd; background: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; color: #666; }
        .date-btn.active { background: var(--active-text); color: white; border-color: var(--active-text); }
        .date-input { border: 1px solid #ddd; padding: 4px; border-radius: 4px; color: #666; }

        /* 内容滚动区 */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* 页面切换 */
        .page { display: none; height: 100%; }
        .page.active { display: block; }

        /* 通用卡片样式 */
        .card { background: var(--card-bg); border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .card-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; border-left: 3px solid var(--active-text); padding-left: 10px; line-height: 1; color: #333; }
        
        /* 绩效概览布局 */
        .perf-layout { display: flex; gap: 20px; height: 100%; }
        .perf-charts { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .perf-stats { width: 320px; display: flex; flex-direction: column; gap: 15px; }
        
        .stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #888; }
        .stat-val { font-weight: bold; color: #333; }

        /* 表格样式 */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th, .data-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .data-table th { background: #f8f9fa; color: #666; font-weight: normal; position: sticky; top: 0; }
        .text-red { color: var(--red); }
        .text-green { color: var(--green); }

        /* 统计指标网格 */
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .grid-item { background: white; padding: 20px; text-align: center; border-radius: 4px; border: 1px solid #eee; }
        .grid-label { color: #888; font-size: 12px; margin-bottom: 5px; }
        .grid-val { font-size: 20px; font-weight: bold; color: #333; }

        /* 图表容器 */
        .chart-container { width: 100%; height: 350px; }
        .full-h-chart { height: calc(100vh - 150px); }

    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">掘金量化 V3 风格</div>
        <div class="nav-item active" onclick="switchPage('p1')">绩效概览</div>
        <div class="nav-item" onclick="switchPage('p2')">持仓分析</div>
        <div class="nav-item" onclick="switchPage('p3')">交易统计</div>
        <div class="nav-item" onclick="switchPage('p4')">每日明细</div>
        <div class="nav-item" onclick="switchPage('p5')">信号分析</div>
        <div class="nav-item" onclick="switchPage('p6')">回测日志</div>
    </div>

    <div class="main">
        <div class="topbar">
            <div class="top-info">
                <span>回测时间: <b id="meta-range">-- 至 --</b></span>
                <span>期初资金: <b id="meta-capital">--</b></span>
            </div>
            <div class="filter-group">
                <select id="date-range-select" class="date-input" onchange="onPresetChange(this.value)">
                    <option value="all">成立以来</option>
                    <option value="this_month">本月</option>
                    <option value="last_month">上月</option>
                    <option value="this_year">本年</option>
                </select>
                <input type="date" id="start-date" class="date-input" onchange="onCustomDateChange()">
                <span>至</span>
                <input type="date" id="end-date" class="date-input" onchange="onCustomDateChange()">
            </div>
        </div>

        <div class="content-scroll">
            
            <div id="p1" class="page active">
                <div class="perf-layout">
                    <div class="perf-charts">
                        <div class="card">
                            <div class="card-title">累计收益</div>
                            <div id="chart-equity" class="chart-container"></div>
                        </div>
                        <div class="card">
                            <div class="card-title">回撤详情</div>
                            <div id="chart-drawdown" class="chart-container" style="height: 250px;"></div>
                        </div>
                        <div class="card">
                            <div class="card-title">每日收益率</div>
                            <div id="chart-daily-ret" class="chart-container" style="height: 200px;"></div>
                        </div>
                    </div>
                    <div class="perf-stats">
                        <div class="card">
                            <div class="card-title">关键指标</div>
                            <div id="key-stats-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="p2" class="page">
                <div class="card">
                    <div class="card-title">资产分布 (现金 vs 持仓)</div>
                    <div id="chart-position" class="chart-container"></div>
                </div>
                <div class="card">
                    <div class="card-title">每日快照</div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr><th>日期</th><th>总资产</th><th>现金</th><th>持仓市值</th><th>当日盈亏</th><th>净值</th></tr>
                            </thead>
                            <tbody id="table-daily"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="p3" class="page">
                <div class="grid-stats" id="all-stats-grid"></div>
            </div>

            <div id="p4" class="page">
                <div class="card" style="height: 100%; display:flex; align-items:center; justify-content:center; color:#999;">
                    暂无每日详细流水数据 (已预留接口)
                </div>
            </div>

            <div id="p5" class="page">
                <div class="card">
                    <div class="card-title">K线与信号 (1分钟)</div>
                    <div id="chart-signal" class="chart-container" style="height: 500px;"></div>
                </div>
                <div class="card">
                    <div class="card-title">成交记录</div>
                    <table class="data-table">
                        <thead>
                            <tr><th>时间</th><th>代码</th><th>方向</th><th>开平</th><th>价格</th><th>数量</th></tr>
                        </thead>
                        <tbody id="table-trades"></tbody>
                    </table>
                </div>
            </div>

            <div id="p6" class="page">
                <div class="card">
                    <div class="card-title">系统日志</div>
                    <div id="log-container" style="font-family: monospace; font-size: 12px; color: #555; white-space: pre-wrap; height: 600px; overflow-y: auto;"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="data.js"></script>
<script>
    // 全局数据
    let rawData = window.BACKTEST_DATA;
    let filteredDaily = [];
    let charts = {};

    // 初始化
    window.onload = function() {
        if(!rawData) { alert("数据加载失败，请确保 data.js 存在"); return; }
        
        // 填充头部信息
        document.getElementById('meta-capital').innerText = rawData.metadata.capital.toLocaleString();
        document.getElementById('meta-range').innerText = `${rawData.metadata.start_date} 至 ${rawData.metadata.end_date}`;
        
        // 初始化日期选择器
        const start = rawData.daily_data[0].date;
        const end = rawData.daily_data[rawData.daily_data.length-1].date;
        document.getElementById('start-date').value = start;
        document.getElementById('end-date').value = end;

        // 渲染所有内容
        applyFilter();
        renderStatsGrid();
        renderLogs();
    };

    // 页面切换
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(pageId).classList.add('active');
        event.currentTarget.classList.add('active');
        
        // 重新调整图表尺寸 (因为 display:none 会导致 ECharts 尺寸计算错误)
        setTimeout(() => {
            Object.values(charts).forEach(c => c.resize());
            if(pageId === 'p5') renderSignalChart(); // 信号图表比较重，延迟加载
        }, 100);
    }

    // 数据过滤核心逻辑
    function applyFilter() {
        const sDate = document.getElementById('start-date').value;
        const eDate = document.getElementById('end-date').value;

        // 过滤每日数据
        filteredDaily = rawData.daily_data.filter(d => d.date >= sDate && d.date <= eDate);

        // 更新图表
        renderPerfCharts();
        renderKeyStats();
        renderPositionChart();
        renderDailyTable();
    }

    // 处理日期预设
    function onPresetChange(val) {
        const today = new Date();
        let start = new Date();
        
        if (val === 'all') {
            document.getElementById('start-date').value = rawData.daily_data[0].date;
            document.getElementById('end-date').value = rawData.daily_data[rawData.daily_data.length-1].date;
        } else {
            if (val === 'this_month') start.setDate(1);
            else if (val === 'last_month') { start.setMonth(start.getMonth()-1); start.setDate(1); }
            else if (val === 'this_year') { start.setMonth(0); start.setDate(1); }
            
            document.getElementById('start-date').value = start.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
        }
        applyFilter();
    }

    function onCustomDateChange() {
        document.getElementById('date-range-select').value = ""; // 清空预设
        applyFilter();
    }

    // --- 绘图函数区 ---

    function initChart(domId) {
        if (charts[domId]) charts[domId].dispose();
        charts[domId] = echarts.init(document.getElementById(domId));
        return charts[domId];
    }

    // 1. 绩效图表
    function renderPerfCharts() {
        const dates = filteredDaily.map(d => d.date);
        
        // 权益曲线
        const chartEq = initChart('chart-equity');
        chartEq.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: 50, right: 20, top: 20, bottom: 20 },
            xAxis: { type: 'category', data: dates },
            yAxis: { scale: true },
            series: [{
                name: '总资产', type: 'line', data: filteredDaily.map(d => d.balance),
                showSymbol: false, lineStyle: { width: 2, color: '#3498db' },
                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(52,152,219,0.3)'}, {offset:1, color:'rgba(52,152,219,0.01)'}]) }
            }]
        });

        // 回撤图
        const chartDd = initChart('chart-drawdown');
        chartDd.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: 50, right: 20, top: 20, bottom: 20 },
            xAxis: { type: 'category', data: dates, show: false },
            yAxis: { type: 'value' },
            series: [{
                name: '回撤', type: 'line', data: filteredDaily.map(d => d.drawdown),
                showSymbol: false, lineStyle: { width: 1, color: '#e74c3c' },
                areaStyle: { color: '#e74c3c' }
            }]
        });

        // 每日收益率
        const chartRet = initChart('chart-daily-ret');
        chartRet.setOption({
            tooltip: { trigger: 'axis', formatter: '{b}<br />{c}%' },
            grid: { left: 50, right: 20, top: 20, bottom: 20 },
            xAxis: { type: 'category', data: dates, show: false },
            yAxis: { type: 'value' },
            series: [{
                type: 'bar', data: filteredDaily.map(d => {
                    const prev = d.balance - d.net_pnl; // 估算昨日余额
                    return prev > 0 ? (d.net_pnl / prev * 100).toFixed(2) : 0;
                }),
                itemStyle: {
                    color: p => p.value >= 0 ? '#27ae60' : '#e74c3c'
                }
            }]
        });
    }

    // 2. 关键指标侧边栏
    function renderKeyStats() {
        const s = rawData.stats;
        const keys = [
            ['总收益率', s['total_return'], true], 
            ['年化收益', s['annual_return'], true],
            ['最大回撤', s['max_drawdown'], true],
            ['夏普比率', s['sharpe_ratio'], false],
            ['胜率', s['winning_rate'], true],
            ['盈亏比', s['profit_loss_ratio'], false]
        ];
        
        let html = '';
        keys.forEach(([name, val, isPct]) => {
            const displayVal = (typeof val === 'number') 
                ? (isPct ? (val).toFixed(2) + '%' : val.toFixed(2)) 
                : val;
            html += `
                <div class="stat-row">
                    <span class="stat-label">${name}</span>
                    <span class="stat-val">${displayVal}</span>
                </div>
            `;
        });
        document.getElementById('key-stats-container').innerHTML = html;
    }

    // 3. 持仓分析图
    function renderPositionChart() {
        const chart = initChart('chart-position');
        const dates = filteredDaily.map(d => d.date);
        
        chart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { top: 0 },
            grid: { left: 50, right: 20, bottom: 30 },
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value', scale: true },
            series: [
                {
                    name: '持仓市值', type: 'bar', stack: 'total', 
                    data: filteredDaily.map(d => Math.abs(d.balance - d.available)), // 简化计算
                    itemStyle: { color: '#f39c12' }
                },
                {
                    name: '可用资金', type: 'bar', stack: 'total',
                    data: filteredDaily.map(d => d.available || d.balance), // 兼容性处理
                    itemStyle: { color: '#bdc3c7' }
                }
            ]
        });
    }

    // 4. 表格渲染
    function renderDailyTable() {
        const html = filteredDaily.slice().reverse().map(d => `
            <tr>
                <td>${d.date}</td>
                <td>${d.balance.toFixed(2)}</td>
                <td>${(d.available || 0).toFixed(2)}</td>
                <td>${Math.abs(d.balance - (d.available || d.balance)).toFixed(2)}</td>
                <td class="${d.net_pnl >= 0 ? 'text-green' : 'text-red'}">${d.net_pnl.toFixed(2)}</td>
                <td>${d.balance.toFixed(2)}</td>
            </tr>
        `).join('');
        document.getElementById('table-daily').innerHTML = html;
    }

    // 5. 交易统计网格
    function renderStatsGrid() {
        const s = rawData.stats;
        let html = '';
        for (const [k, v] of Object.entries(s)) {
            html += `
                <div class="grid-item">
                    <div class="grid-label">${k}</div>
                    <div class="grid-val">${typeof v === 'number' ? v.toLocaleString() : v}</div>
                </div>
            `;
        }
        document.getElementById('all-stats-grid').innerHTML = html;
    }

    // 6. 信号图 (最复杂的部分)
    function renderSignalChart() {
        if (!rawData.klines || rawData.klines.length === 0) return;
        
        const chart = initChart('chart-signal');
        
        // 解析K线数据: [Time, Open, Close, Low, High, Volume]
        const dates = rawData.klines.map(k => k[0]);
        const ohlc = rawData.klines.map(k => [k[1], k[2], k[3], k[4]]);
        const vols = rawData.klines.map((k, i) => [i, k[5], k[1]>k[2]?-1:1]);

        // 解析交易信号
        const marks = [];
        rawData.trades.forEach(t => {
            marks.push({
                name: t.offset,
                coord: [t.datetime, t.price],
                value: t.direction === '多' ? 'Buy' : 'Sell',
                itemStyle: { color: t.direction === '多' ? '#e74c3c' : '#27ae60' },
                symbol: t.direction === '多' ? 'arrow' : 'arrow',
                symbolRotate: t.direction === '多' ? 0 : 180,
                symbolOffset: t.direction === '多' ? [0, 10] : [0, -10]
            });
        });

        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            grid: [
                { left: '5%', right: '5%', height: '60%' },
                { left: '5%', right: '5%', top: '75%', height: '15%' }
            ],
            axisPointer: { link: { xAxisIndex: 'all' } },
            xAxis: [
                { type: 'category', data: dates, scale: true, splitLine: {show:false} },
                { type: 'category', data: dates, gridIndex: 1, show: false }
            ],
            yAxis: [
                { scale: true, splitArea: { show: true } },
                { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: {show:false} }
            ],
            dataZoom: [{ type: 'inside', start: 90, end: 100 }, { show: true, type: 'slider', top: '92%' }],
            series: [
                {
                    name: 'K线', type: 'candlestick', data: ohlc,
                    itemStyle: { color: '#e74c3c', color0: '#27ae60', borderColor: '#e74c3c', borderColor0: '#27ae60' },
                    markPoint: { data: marks, symbolSize: 10 }
                },
                {
                    name: '成交量', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: vols.map(v=>v[1]),
                    itemStyle: { color: (params) => vols[params.dataIndex][2]>0 ? '#e74c3c' : '#27ae60' }
                }
            ]
        });

        // 渲染交易表
        const tradeHtml = rawData.trades.map(t => `
            <tr>
                <td>${t.datetime}</td><td>${t.symbol}</td>
                <td class="${t.direction==='多'?'text-red':'text-green'}">${t.direction}</td>
                <td>${t.offset}</td><td>${t.price}</td><td>${t.volume}</td>
            </tr>
        `).join('');
        document.getElementById('table-trades').innerHTML = tradeHtml;
    }

    // 7. 日志
    function renderLogs() {
        if(rawData.logs) {
            document.getElementById('log-container').innerText = rawData.logs.join('\n');
        }
    }

    // 窗口调整适配
    window.onresize = function() {
        Object.values(charts).forEach(c => c.resize());
    };
</script>

</body>
</html>