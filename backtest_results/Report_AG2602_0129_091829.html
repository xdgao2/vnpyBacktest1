<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>回测分析 - AG2602</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --main-blue: #3498db; --bg-gray: #f4f7f9; --sidebar-bg: #2c3e50; }
        body { font-family: sans-serif; margin: 0; background: var(--bg-gray); display: flex; height: 100vh; }
        
        /* 侧边栏导航 */
        .sidebar { width: 160px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .nav-item { padding: 20px; cursor: pointer; border-bottom: 1px solid #3e4f5f; text-align: center; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--main-blue); font-weight: bold; }
        
        /* 主显示区 */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; box-sizing: border-box; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        
        /* 卡片与网格 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-label { color: #7f8c8d; font-size: 13px; margin-bottom: 5px; }
        .stat-value { font-size: 22px; font-weight: bold; color: #2c3e50; }
        
        .chart-box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; min-height: 450px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #606266; }
        .text-red { color: #e74c3c; } .text-green { color: #27ae60; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="nav-item active" onclick="switchPage('page-overview')">收益概览</div>
        <div class="nav-item" onclick="switchPage('page-positions')">持仓分析</div>
        <div class="nav-item" onclick="switchPage('page-details')">数据详情</div>
    </div>

    <div class="main-content">
        <div id="page-overview" class="page active">
            <div id="stats-grid" class="stats-grid"></div>
            <div class="chart-box" id="chart-balance"></div>
            <div class="chart-box" id="chart-drawdown"></div>
        </div>

        <div id="page-positions" class="page">
            <div class="chart-box" id="chart-pos"></div>
        </div>

        <div id="page-details" class="page">
            <table>
                <thead>
                    <tr><th>日期</th><th>收盘价</th><th>持仓</th><th>当日盈亏</th><th>当前净值</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script id="backtest-json" type="application/json">{"metadata": {"symbol": "AG2602", "strategy": "ModularDoubleMaStrategy", "run_at": "2026-01-29 09:18:29"}, "stats": {}, "daily_data": []}</script>

    <script>
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');
            // 重新触发窗口调整，确保 Plotly 图表能够自适应宽度
            window.dispatchEvent(new Event('resize'));
        }

        window.onload = function() {
            try {
                const data = JSON.parse(document.getElementById('backtest-json').textContent);
                renderReport(data);
            } catch (e) {
                console.error("Data Parse Error:", e);
                document.body.innerHTML = "<h2 style='color:red; margin:50px;'>报告解析异常，请检查 JSON 格式</h2>";
            }
        };

        function renderReport(report) {
            const stats = report.stats;
            const daily = report.daily_data;

            // 1. 渲染统计卡片
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = Object.entries(stats).map(([k, v]) => `
                <div class="stat-card">
                    <div class="stat-label">${k}</div>
                    <div class="stat-value">${typeof v === 'number' ? v.toLocaleString() : v}</div>
                </div>
            `).join('');

            // 2. 准备图表轴
            const dates = daily.map(d => d.date);
            const balances = daily.map(d => d.balance);
            const drawdowns = daily.map(d => d.drawdown);
            const positions = daily.map(d => d.pos);

            // 3. 绘图
            Plotly.newPlot('chart-balance', [{
                x: dates, y: balances, type: 'scatter', mode: 'lines', name: '净值曲线', line: {color: '#3498db'}
            }], { title: '权益净值 (Balance)' });

            Plotly.newPlot('chart-drawdown', [{
                x: dates, y: drawdowns, fill: 'tozeroy', type: 'scatter', name: '回撤', line: {color: '#e74c3c'}
            }], { title: '历史回撤 (Drawdown)' });

            Plotly.newPlot('chart-pos', [{
                x: dates, y: positions, type: 'bar', name: '持仓量', marker: {color: '#f39c12'}
            }], { title: '历史仓位分布' });

            // 4. 填充表格
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = daily.slice(-100).reverse().map(d => `
                <tr>
                    <td>${d.date}</td>
                    <td>${d.close}</td>
                    <td style="font-weight:bold">${d.pos}</td>
                    <td class="${d.net_pnl >= 0 ? 'text-green' : 'text-red'}">${d.net_pnl}</td>
                    <td>${d.balance}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>